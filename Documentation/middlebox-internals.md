# Middlebox Internals

## Configuration Module
Middlebox can be configured/managed in two way.
  1. CLI
  2. camera switch web interface.

### CLI
The command line interface is integral part of middlebox software suite and
it starts when the middlebox is starting. The CLI offers pre-defined
configuration options to let users configuring the middlebox.

### Web interface
The web interface offers only a switch interface to the user. The purpose of the
GUI interface is for turning ON/OFF the connected camera when needed. The
webpage is serviced by a small webserver module that running as part of
middlebox.

### Middlebox configuration components
  1. CLI module :-
  CLI module offers command-line options to configure middlebox
  2. Conf module(Core) :-
  The core of middlebox, the master thread that control all other modules.
  3. middlebox webserver module :-
  The webserver module to serve the switch page.
  4. middlebox webclient :-
  The webclient module for notifying the webserver about system changes. The
  system changes are propagated outside using this web client.The webclient
  connected to the middlebox webserver over websockets.
  5. Neoview webserver App :-
  The main webserver application that offers the Neoview website. middlebox
  sends system update to this main webserver. The neoview webserver is connected
  to middlebox webserver via websockets to collect the system status messages.

#### How CLI operates in Middlebox
Any interaction with middlebox core(conf module) is via a conf-queue.

  1. CLI create a conf-queue message(so called ipc message) with OP_CODE,
  MODULE_CODE and finally the parameters that needed for the specific OP.
  2. CLI enqueue the message into the conf-queue for the processing.
  3. The conf(core) thread reads the queue for incoming message in a continuous
  loop. The new message picked up by the conf module.
  4. Validate the configuration message. Do the integrity check.
  5. Perform the operation. This could be START CAMERA, ADD CAMERA, CONFIGURE
  WEBSERVER etc
  6. Send out system status externally via webclient if necessary.

#### How web interface operates in Middlebox

  1. User turn ON/OFF camera on middlebox web interface.
  2. Disable the camera switch UI until the operation completes.
  3. web interface sends corresponding json message to middlebox webserver
  4. Web server receives the message, Validate it.
  5. Create a conf-queue message with OP-CODE 'start/stop camera' based on
  recieved json message.
  6. Enqueue the conf-queue with created conf message
  7. Conf(core) module reads the message from the queue, Validate it.
  8. notify camera thread to start/stop recording.
  9. Update the camera status to DEFERRED in DB. The status should be DEFERRED
  until the camera recording is completely stopped/started.
  10. camera thread completes its start/stop. Update the DB with camera status
  ON/OFF.
  11. Camera thread asks webclient to send status change notification to the
  middlebox webserver.
  12. Webserver receives the status update notification. It broadcasts status of
  all cameras to all the connected clients.
  13. The switch page receives this notification, Update the camera status
  accordingly in UI.

##### JSON formats
The interaction with middlebox webserver is using json data. The following
samples shows how its looks like.

web UI request to turn camera ON,

```
    {
        "name" : "camera1",
        "status" : 2,
        "description" : "Camera in ICU",
        "token" : None
    }
```
status '2' refers to ON. The detailed camera status flag information can be
found in nvdb module.

The webclient notification request sample is given below. From any module of
middlebox, it is possible to invoke the send_notify call of webclient. The
notify call consist of unique token generated for that specific request.
On reception of notify request, the webserver first validate the token to ensure
the request is generated by the local client itself. In case of token mismatch,
server doesnt process the request.

```
    {
        "token" : "3f9451f1-abe5-4002-bfe6-79fc8dbc96f2"
    }
```
The webserver then reads all configured camera details from the DB, send it to
all the connected clients.

A sample webserver camera status update json is given below.

```
{
    "name" : "camera1",
    "status" : 2,
    "description" : "Camera in ICU",
    "token" : None
}
{
    "name" : "camera2",
    "status" : 1,
    "description" : "Camera in LAB",
    "token" : None
}
```
